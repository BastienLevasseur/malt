<% layout('page-layout') -%>

<!-- To manage the function list on the left -->
<% script('func-list-view.js') -%>
<% script('func-list-selector.js') -%>
<% script('func-list-selector-btn.js') -%>

<!-- To manage code view -->
<% script('source-editor.js') -%>

<!-- Used to get color gradiant into source editor -->
<% script('deps/d3js/d3.min.js') -%>

<!-- Use to display info when clicking on editor annotations -->
<% script('call-site-detail-view.js') -%>

<!-- Use to display call stack tree -->
<% script('call-stacks-view.js') %>

<!-- lib for code editor -->
<% script('deps/codemirror/lib/codemirror.js') -%>
<% script('deps/codemirror/mode/clike/clike.js') -%>
<% script('deps/codemirror/mode/fortran/fortran.js') -%>
<% script('deps/codemirror/addon/selection/active-line.js') -%>
<% stylesheet('deps/codemirror/lib/codemirror.css') -%>
<% stylesheet('deps/codemirror/theme/lesser-dark.css') -%>
<% stylesheet('deps/codemirror/theme/eclipse.css') -%>

<!-- Used to build the tree table to show call stacks -->
<% script('deps/jquery-treetable/javascripts/src/jquery.treetable.js') -%>
<% stylesheet('deps/jquery-treetable/stylesheets/jquery.treetable.css') %>
<% stylesheet('deps/jquery-treetable/stylesheets/jquery.treetable.theme.default.css') %>

<!-- ****************** STACK ANALYSER *************** -->
<div class="container-fluid">
	<div class="row">
		<div class="col-sm-5 col-md-4 col-lg-3 sidebar">
			<!-- Selection -->
			<div id='matt-func-list-selector'>
			</div>
			
		
			<!-- Func lis -->
			<ul class="nav nav-sidebar" id='matt-func-list'>
			</ul>
		</div>
		
		<!-- Source editor -->
		<div class="col-sm-7 col-md-8 col-lg-9 main">
			<div id='matt-source-editor'></div>
			<div id='matt-alloc-info' style="width:30%;float:left;"></div>
			<div id='matt-alloc-stacks' style="width:70%;float:left;">
				<table id='matt-alloc-stacks-tree'>
					<thead>
						<tr>
							<th>Function</th>
							<th>Metric</th>
						</tr>
					</thead>
					<tbody>
						<!--<tr class="branch expanded" data-tt-id="000">
          <td><span style="padding-left: 0px;" class="indenter"></span>app</td>
        </tr>
        <tr class="branch expanded" data-tt-id="100" data-tt-parent-id="000">
          <td><span style="padding-left: 19px;" class="indenter"></span>controllers</td>
        </tr>
        <tr class="leaf expanded" data-tt-id="500" data-tt-parent-id="100">
          <td><span style="padding-left: 38px;" class="indenter"></span>application_controller.rb</td>
        </tr>
        <tr class="leaf expanded" data-tt-id="200" data-tt-parent-id="000">
          <td><span style="padding-left: 19px;" class="indenter"></span>helpers</td>
        </tr>
        <tr class="leaf expanded" data-tt-id="300" data-tt-parent-id="000">
          <td><span style="padding-left: 19px;" class="indenter"></span>models</td>
        </tr>
        <tr class="leaf expanded" data-tt-id="400" data-tt-parent-id="000">
          <td><span style="padding-left: 19px;" class="indenter"></span>views</td>
        </tr>-->
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<script type='text/javascript'>
	$( document ).ready(function() {
		//left menu with buttons and func list
		var selectorButtons = new MattFuncListSelectorButtons('matt-func-list-selector',{count:30});
		
		//create left menu
		var leftFuncList = new MattFuncListView('matt-func-list',MATT_FUNC_LIST_LEFT_MENU,selectorButtons.getSelector());
		leftFuncList.render();
		
		//setup code editor
		var codeEditor = new MattSourceEditor('matt-source-editor',selectorButtons.getSelector());
		
		//setup detail zone
		var detailView = new MattCallSiteDetailView('matt-alloc-info');
		
		//call stacks
		var callStacks = new MattCallStacksView('matt-alloc-stacks-tree',selectorButtons.getSelector());
		
		//dispatch event when clicking on entry of left menu
		leftFuncList.onClick = function(details)
		{
			//alert('click on left menu TODO '+details.file+'\n'+JSON.stringify(details,null,'\t'));
			//codeEditor.moveToFile(details.file);
			//codeEditor.moveToFileLine(details.file,details.line);
			codeEditor.moveToFileFunction(details.file,details.function);
			detailView.render(details);
			callStacks.updateFunc(details.function);
		}
		
		//dispatch click on annotations
		codeEditor.onClick = function(details)
		{
			detailView.render(details);
			callStacks.update(details.file,details.line);
		}
		
		//dispatch update of view mode (metric...)
		selectorButtons.getSelector().onChange = function()
		{
			leftFuncList.render();
			codeEditor.redrawAnnotations();
		}
		
		//distpatch click on stack tree
		callStacks.onClick = function(location,info)
		{
			//alert(JSON.stringify(info));
			codeEditor.moveToFileFunction(location.file,location.function);
		}
		
		////////////////////////////////////////////////////////////////////////////////////////////
		/*
		selectorButtons.getSelector().onChange = function(){
			leftFuncList.render();
			mattEditor.setConfig(mattFuncListSelector.getSelector(),mattFuncListSelector.mode);
			mattEditor.redrawAnnotations();
		};
		leftFuncList.onClick = function(details)
		{
			alert('ok');
			mattEditor.setConfig(mattFuncListSelector.getSelector(),mattFuncListSelector.mode);
			mattEditor.update(details,true);
		}*/
	});
</script>
